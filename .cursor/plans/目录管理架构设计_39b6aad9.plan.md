---
name: 目录管理架构设计
overview: 设计一个完整的本地存储、技能开发、代码生成的目录管理架构，明确区分工作目录、客户端运行目录、输出目录的关系，以及技能和MCP的共享策略。
todos:
  - id: "1"
    content: 创建 DirectoryManager 服务，统一管理所有目录路径和初始化逻辑
    status: pending
  - id: "2"
    content: 修改 ConfigStore、SessionStore、SkillManager、ScriptStore、MCPClientService 使用 DirectoryManager
    status: pending
  - id: "3"
    content: 在设置界面添加目录管理tab，显示目录路径和导出/导入功能
    status: pending
  - id: "4"
    content: 实现目录结构的文档说明和迁移逻辑
    status: pending
isProject: false
---

# OpenCowork 目录管理架构设计方案

## 一、目录概念定义

### 1. 工作目录（Working Directory）

**定义**：用户在协作模式下选择的项目工作目录，AI可以在此目录内进行文件操作。

**特点**：

- 用户主动选择，可多个
- 用于项目文件读写
- 每个项目可以有不同的工作目录
- 存储在 `authorizedFolders` 配置中

**示例**：`/Users/shilei/projects/my-app`

### 2. 客户端运行目录（.opencowork）

**定义**：应用配置和数据存储目录，位于用户主目录下。

**路径**：`~/.opencowork/`（macOS/Linux）或 `%USERPROFILE%\.opencowork\`（Windows）

**用途**：

- 存储应用配置
- 存储会话历史
- 存储用户自定义技能
- 存储MCP配置

### 3. 输出文件目录（Output Directory）

**定义**：AI生成的代码文件写入的位置。

**当前实现**：直接写入到工作目录

**建议**：保持写入到工作目录，但可以支持子目录组织

## 二、目录结构设计

```
~/.opencowork/                          # 客户端运行目录（用户级，不共享）
├── config/
│   ├── app-config.json                 # 应用配置（electron-store）
│   ├── sessions.json                   # 会话历史（electron-store）
│   └── permissions.json               # 权限配置（electron-store）
├── skills/                             # 用户自定义技能（用户级，可导出分享）
│   ├── chrome-agent/                   # 自动化脚本
│   │   ├── login_xgpt.js
│   │   └── ...
│   └── [user-custom-skills]/           # 其他用户自定义技能
├── mcp/
│   ├── mcp.json                        # MCP服务器配置（用户级）
│   └── mcp_storage.json                # MCP存储数据（用户级）
├── cache/                              # 缓存目录（可清理）
│   └── ...
└── logs/                               # 日志目录
    └── ...

工作目录（用户选择，如 /Users/shilei/projects/my-app）
├── [项目文件]                          # 用户项目文件
├── .opencowork/                        # 可选：项目级配置（如果支持）
│   ├── project-config.json            # 项目特定配置
│   └── artifacts/                      # 项目生成的文件记录
└── [生成的代码文件]                    # AI生成的代码直接写入这里
```

## 三、共享策略设计

### 1. 全局共享（打包在应用中）

**位置**：`resources/skills/` 和 `resources/mcp/`（打包时包含）

**内容**：

- 内置技能（Built-in Skills）
- 内置MCP服务器配置模板

**特点**：

- 随应用分发，所有用户都有
- 首次运行时复制到 `~/.opencowork/skills/`
- 更新应用时自动更新内置技能

**实现**：已在 `SkillManager.initializeDefaults()` 中实现

### 2. 用户级（不共享，但可导出）

**位置**：`~/.opencowork/`

**内容**：

- 用户配置（API Keys、模型选择等）
- 会话历史
- 用户自定义技能
- 用户MCP配置
- 自动化脚本

**特点**：

- 每个用户独立
- 可以导出/导入分享
- 不随应用更新而覆盖

### 3. 项目级（可选，未来扩展）

**位置**：`工作目录/.opencowork/`

**内容**：

- 项目特定配置
- 项目生成的文件索引
- 项目特定的技能引用

**特点**：

- 跟随项目，可以版本控制
- 团队可以共享项目配置

## 四、关键目录详细设计

### 1. 技能目录管理

**全局技能**（`resources/skills/` → `~/.opencowork/skills/`）：

- 应用内置技能，首次运行复制
- 更新应用时，新增技能会自动添加
- 用户修改的技能不会被覆盖

**用户技能**（`~/.opencowork/skills/`）：

- 用户自定义技能
- 从社区导入的技能
- 可以导出为 `.skill` 包分享

**自动化脚本**（`~/.opencowork/skills/chrome-agent/`）：

- 存储用户生成的自动化脚本
- 通过"自动化"tab管理
- 可以删除和重新生成

### 2. MCP配置管理

**内置MCP配置**（`resources/mcp/builtin-mcp.json`）：

- 应用内置的MCP服务器配置模板
- 首次运行创建 `~/.opencowork/mcp.json`
- 更新应用时更新配置模板

**用户MCP配置**（`~/.opencowork/mcp.json`）：

- 用户自定义的MCP服务器
- 用户禁用的服务器会被保留
- 可以导出/导入配置

### 3. 会话历史管理

**存储位置**：`~/.opencowork/`（通过 electron-store）

**存储内容**：

- 会话消息历史
- 会话元数据（标题、时间等）
- 当前会话ID

**特点**：

- 用户级，不共享
- 可以导出/导入
- 支持清理和删除

### 4. 代码生成管理

**写入位置**：工作目录（用户选择的授权文件夹）

**组织方式**：

- 直接写入到工作目录根目录或指定子目录
- 可以通过 `write_file` 工具指定完整路径
- 支持在工作目录下创建项目结构

**文件追踪**：

- 通过 `artifacts` 数组追踪生成的文件
- 可以显示在界面上
- 可以打开文件位置

## 五、实现方案

### 1. 创建目录管理服务

**文件**：`electron/config/DirectoryManager.ts`

**功能**：

- 统一管理所有目录路径
- 提供目录初始化方法
- 提供目录验证和创建方法
- 区分开发环境和生产环境

### 2. 修改现有代码

**ConfigStore.ts**：

- 使用 `DirectoryManager` 获取配置目录
- 保持现有功能不变

**SessionStore.ts**：

- 使用 `DirectoryManager` 获取存储目录
- 保持现有功能不变

**SkillManager.ts**：

- 使用 `DirectoryManager` 获取技能目录
- 区分内置技能和用户技能

**ScriptStore.ts**：

- 使用 `DirectoryManager` 获取脚本目录
- 支持自定义脚本目录

**MCPClientService.ts**：

- 使用 `DirectoryManager` 获取MCP配置目录
- 保持现有功能不变

### 3. 添加目录配置界面

**SettingsView.tsx**：

- 添加"目录管理"tab
- 显示各目录路径
- 支持打开目录
- 支持导出/导入配置

## 六、目录权限和安全

### 1. 工作目录权限

- 用户主动授权
- 支持多个授权目录
- 写入已授权目录无需确认

### 2. 客户端目录权限

- 应用自动创建和管理
- 用户可以直接访问
- 支持手动修改配置

### 3. 安全考虑

- 工作目录外的文件操作需要授权
- API Keys等敏感信息加密存储
- 会话历史包含敏感信息，不共享

## 七、迁移和兼容性

### 1. 现有数据迁移

- 检测现有配置
- 自动迁移到新结构
- 保持向后兼容

### 2. 版本升级

- 内置技能自动更新
- 用户数据保持不变
- 配置格式版本管理

## 八、未来扩展

### 1. 项目级配置（可选）

- 在工作目录下创建 `.opencowork/` 目录
- 存储项目特定配置
- 支持版本控制

### 2. 技能市场（可选）

- 在线技能库
- 一键安装技能
- 技能评分和评论

### 3. 团队协作（可选）

- 共享项目配置
- 团队技能库
- 协作历史记录