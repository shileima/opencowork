# 部署流程图

## 完整部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                     开始部署                                  │
│                  pnpm run deploy                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 1: 检查 webstatic 是否安装                              │
│  ✓ 已安装: 继续                                               │
│  ✗ 未安装: 显示安装命令并退出                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 2: 读取项目信息                                          │
│  • 项目名称: qacowork                                         │
│  • 当前版本: 1.0.0                                            │
│  • 描述: QACowork - 你的数字测试同事                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 3: 更新版本号（可选）                                    │
│  • --skip-bump: 跳过此步骤                                    │
│  • --patch: 1.0.0 -> 1.0.1 (默认)                            │
│  • --minor: 1.0.0 -> 1.1.0                                   │
│  • --major: 1.0.0 -> 2.0.0                                   │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 4: 构建项目（可选）                                      │
│  • --skip-build: 跳过此步骤                                   │
│  • 执行: pnpm run build                                       │
│  • 生成 dist 目录                                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 5: 检查环境变量                                          │
│  • WEBSTATIC_APPKEY                                          │
│  • WEBSTATIC_TOKEN                                           │
│  • WEBSTATIC_ENV (可选，默认 prod)                            │
│  ✓ 已配置: 继续                                               │
│  ✗ 未配置: 显示配置说明并退出                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 6: 上传到 CDN                                            │
│  • 执行 webstatic upload 命令                                 │
│  • 上传 dist 目录下的所有文件                                  │
│  • 跳过重复文件 (--skip-duplicate)                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤 7: 生成部署报告                                          │
│  • 保存到 deploy-report.json                                 │
│  • 包含: 项目信息、版本号、CDN 地址、部署时间                   │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                     部署完成                                  │
│  显示 CDN 地址和部署信息                                       │
└─────────────────────────────────────────────────────────────┘
```

## 错误处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    检测到错误                                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
         ┌────────┴────────┐
         │   错误类型？      │
         └────────┬────────┘
                  │
    ┌─────────────┼─────────────┬─────────────┐
    │             │             │             │
    ▼             ▼             ▼             ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│webstatic│  │环境变量│  │构建失败│  │上传失败│
│未安装   │  │未配置  │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│显示安装│  │显示配置│  │显示错误│  │显示错误│
│命令    │  │说明    │  │信息    │  │信息    │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    └───────────┴───────────┴───────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                    退出程序                                   │
│                   exit code: 1                               │
└─────────────────────────────────────────────────────────────┘
```

## 版本号升级逻辑

```
当前版本: 1.2.3
         │
         ▼
    ┌────────┐
    │升级类型│
    └────┬───┘
         │
    ┌────┴────┬────────┬────────┐
    │         │        │        │
    ▼         ▼        ▼        ▼
┌──────┐  ┌──────┐ ┌──────┐ ┌──────┐
│ patch│  │minor │ │major │ │ skip │
└──┬───┘  └──┬───┘ └──┬───┘ └──┬───┘
   │         │        │        │
   ▼         ▼        ▼        ▼
 1.2.4     1.3.0    2.0.0    1.2.3
```

## 配置加载流程

```
┌─────────────────────────────────────────────────────────────┐
│                  启动部署脚本                                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  检查 .env 文件是否存在                                        │
└─────────────────┬───────────────────────────────────────────┘
                  │
         ┌────────┴────────┐
         │   .env 存在？    │
         └────────┬────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
    ┌────────┐        ┌────────┐
    │  是    │        │  否    │
    └───┬────┘        └───┬────┘
        │                 │
        ▼                 ▼
┌────────────┐    ┌────────────┐
│读取 .env   │    │使用环境变量│
│解析变量    │    │(如果已设置)│
│加载到 env  │    │            │
└───┬────────┘    └───┬────────┘
    │                 │
    └────────┬────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│  检查必需的环境变量                                            │
│  • WEBSTATIC_APPKEY                                          │
│  • WEBSTATIC_TOKEN                                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
         ┌────────┴────────┐
         │   都已配置？     │
         └────────┬────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
    ┌────────┐        ┌────────┐
    │  是    │        │  否    │
    └───┬────┘        └───┬────┘
        │                 │
        ▼                 ▼
┌────────────┐    ┌────────────┐
│继续部署    │    │显示错误    │
│            │    │退出程序    │
└────────────┘    └────────────┘
```

## 文件上传流程

```
┌─────────────────────────────────────────────────────────────┐
│  准备上传文件                                                  │
│  • 源目录: dist/                                              │
│  • 目标: CDN                                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  扫描 dist 目录                                                │
│  • 收集所有文件                                                │
│  • 计算文件哈希                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  检查重复文件 (--skip-duplicate)                              │
│  • 比较文件名和内容                                            │
│  • 跳过已存在的相同文件                                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  上传文件到 CDN                                                │
│  • 使用 webstatic upload 命令                                 │
│  • 显示上传进度                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  验证上传结果                                                  │
│  • 检查返回状态                                                │
│  • 生成 CDN URL                                               │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  上传完成                                                      │
│  返回 CDN 地址                                                 │
└─────────────────────────────────────────────────────────────┘
```

## 命令行参数处理

```
pnpm run deploy -- [options]
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  解析命令行参数                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
    ┌─────────────┼─────────────┬─────────────┐
    │             │             │             │
    ▼             ▼             ▼             ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│--skip- │  │--skip- │  │--major │  │--minor │
│bump    │  │build   │  │--minor │  │--patch │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│跳过版本│  │跳过构建│  │设置升级│  │设置升级│
│号升级  │  │步骤    │  │类型    │  │类型    │
└────────┘  └────────┘  └────────┘  └────────┘
```

## 测试流程

```
pnpm run deploy:test
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  运行测试套件                                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
    ┌─────────────┼─────────────┬─────────────┐
    │             │             │             │
    ▼             ▼             ▼             ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│文件检查│  │工具检查│  │环境检查│  │文档检查│
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│4 tests │  │1 test  │  │2 tests │  │3 tests │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    └───────────┴───────────┴───────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  语法检查                                                      │
│  1 test                                                      │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  测试总结                                                      │
│  • 通过: 11                                                   │
│  • 失败: 0                                                    │
│  • 总计: 11                                                   │
└─────────────────────────────────────────────────────────────┘
```

## 使用场景

### 场景 1: 首次部署

```
用户 → 配置 .env → 运行 deploy:test → 运行 deploy → 成功
```

### 场景 2: 日常更新

```
用户 → 修改代码 → 运行 deploy → 自动升级版本 → 成功
```

### 场景 3: 重大版本发布

```
用户 → 修改代码 → 运行 deploy --major → 升级主版本 → 成功
```

### 场景 4: 快速修复

```
用户 → 修改代码 → 运行 deploy --skip-bump → 不升级版本 → 成功
```

## 相关命令速查

| 命令 | 说明 | 版本变化 |
|------|------|---------|
| `pnpm run deploy` | 基本部署 | 1.0.0 → 1.0.1 |
| `pnpm run deploy -- --patch` | patch 版本 | 1.0.0 → 1.0.1 |
| `pnpm run deploy -- --minor` | minor 版本 | 1.0.0 → 1.1.0 |
| `pnpm run deploy -- --major` | major 版本 | 1.0.0 → 2.0.0 |
| `pnpm run deploy -- --skip-bump` | 不升级版本 | 1.0.0 → 1.0.0 |
| `pnpm run deploy -- --skip-build` | 跳过构建 | - |
| `pnpm run deploy:test` | 测试配置 | - |

## 返回文档

- [部署快速开始](./DEPLOYMENT_QUICKSTART.md)
- [完整部署文档](./DEPLOYMENT.md)
- [优化总结](./DEPLOYMENT_IMPROVEMENTS.md)
- [文档索引](./README.md)
