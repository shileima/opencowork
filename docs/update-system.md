# 资源热更新系统说明

## 系统概述

本项目采用 **GitHub Actions + 热更新** 的双层更新架构：
- **完整更新**：通过 Electron 安装包更新整个应用
- **热更新**：仅更新前端、技能、MCP 等资源文件，无需重装应用

---

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        GitHub Actions 构建流程                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   开发者推送 Tag (v1.0.0)                                                    │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────┐                                                      │
│   │  Create Release  │  ← 创建 GitHub Release                               │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │                    并行构建 (3 平台)                               │     │
│   │  ┌─────────┐    ┌─────────┐    ┌─────────────────────────────┐  │     │
│   │  │ Windows │    │  macOS  │    │         Linux               │  │     │
│   │  │  .exe   │    │  .dmg   │    │  .AppImage + 资源包打包     │  │     │
│   │  └─────────┘    └─────────┘    └─────────────────────────────┘  │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │                    上传到 Release                                 │     │
│   │   • *.dmg, *.exe, *.AppImage (安装包)                            │     │
│   │   • resource-manifest.json   (资源清单)                          │     │
│   │   • resources-v*.zip         (资源包)                            │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        客户端热更新流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   应用启动                                                                   │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────┐      ┌───────────────────────┐                       │
│   │ 检查本地版本     │ ───▶ │ 拉取远程 manifest     │                       │
│   │ (热更新目录优先)  │      │ (GitHub Release)      │                       │
│   └─────────────────┘      └───────────┬───────────┘                       │
│                                        │                                    │
│                                        ▼                                    │
│                            ┌─────────────────────┐                         │
│                            │  版本 & Hash 比对    │                         │
│                            └──────────┬──────────┘                         │
│                                       │                                     │
│                     ┌─────────────────┴─────────────────┐                  │
│                     ▼                                   ▼                   │
│            ┌───────────────┐                   ┌────────────────┐          │
│            │  无需更新      │                   │  发现更新       │          │
│            │  (Hash 一致)   │                   │  (Hash 不同)    │          │
│            └───────────────┘                   └───────┬────────┘          │
│                                                        │                    │
│                                                        ▼                    │
│                                              ┌─────────────────┐           │
│                                              │  下载资源包 zip  │           │
│                                              │  (带缓存机制)    │           │
│                                              └────────┬────────┘           │
│                                                       │                     │
│                                                       ▼                     │
│                                              ┌─────────────────┐           │
│                                              │  增量解压文件    │           │
│                                              │  (仅更新变化的)  │           │
│                                              └────────┬────────┘           │
│                                                       │                     │
│                                                       ▼                     │
│                                              ┌─────────────────┐           │
│                                              │  写入热更新目录  │           │
│                                              │  ~/userData/    │           │
│                                              │  hot-update/    │           │
│                                              └────────┬────────┘           │
│                                                       │                     │
│                                                       ▼                     │
│                                              ┌─────────────────┐           │
│                                              │  保存新 manifest │           │
│                                              │  下次启动生效    │           │
│                                              └─────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 关键文件

| 文件 | 用途 |
|------|------|
| `.github/workflows/release.yml` | CI/CD 构建配置 |
| `scripts/generate-resource-manifest.mjs` | 生成资源清单 |
| `resource-manifest.json` | 资源文件索引 (版本+Hash) |
| `electron/updater/ResourceUpdater.ts` | 客户端更新逻辑 |

---

## 技术要点

### 1. 构建阶段 (GitHub Actions)

```
推送 Tag → 创建 Release → 三平台并行构建 → 生成资源清单 → 打包上传
```

- **触发条件**：推送 `v*` 格式的 Git Tag
- **产物**：安装包 + `resource-manifest.json` + `resources-v*.zip`
- **资源清单内容**：版本号 + 构建时间 + 所有文件的 SHA256 Hash

### 2. 更新检测 (客户端)

```typescript
本地版本 = 热更新版本 || 应用版本
远程版本 = GitHub Release 最新版本

if (远程版本 > 本地版本 || 文件Hash不匹配) {
  触发更新
}
```

### 3. 增量更新机制

- 对比本地与远程 manifest 的文件 Hash
- 仅下载/更新有变化的文件
- 缓存已下载的 zip 包，避免重复下载

### 4. 热更新目录

```
~/Library/Application Support/[AppName]/
├── hot-update/           ← 热更新资源存放处
│   ├── dist/            ← 前端资源
│   ├── resources/       ← 技能、MCP 等
│   └── manifest.json    ← 当前版本清单
└── update-temp/         ← 临时下载目录
```

**加载优先级**：热更新目录 > 应用内置目录

---

## 监控的资源目录

| 目录 | 内容 |
|------|------|
| `dist/` | 前端构建产物 |
| `resources/skills/` | AI 技能定义 |
| `resources/mcp/` | MCP 服务配置 |
| `resources/node/` | 内置 Node.js |
| `resources/playwright/` | Playwright 浏览器 |

---

## 发版流程

```bash
# 1. 更新版本号
npm version patch  # 或 minor / major

# 2. 推送 tag
git push && git push --tags

# 3. GitHub Actions 自动构建并发布
```

---

## 错误处理

- **网络失败**：指数退避重试 (最多 3 次)
- **速率限制**：自动延长检查间隔至 6 小时
- **更新失败**：可清理热更新目录回退到内置版本
