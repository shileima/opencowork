# 终端模式分析

## 概述

当前终端实现支持两种模式：
1. **PTY 模式**（伪终端，使用 `node-pty`）
2. **Pipe 模式**（管道模式，使用 `child_process.spawn`）

## 模式选择逻辑

### 优先级顺序

1. **PTY 模式**（优先）
   - 平台：非 Windows（macOS/Linux）
   - 条件：`node-pty` 模块可用且成功启动
   - 回退：如果 PTY 失败，自动回退到 Pipe 模式

2. **Pipe 模式**（回退）
   - 平台：Windows，或 PTY 失败时
   - 条件：使用 `child_process.spawn` + `stdio: ['pipe', 'pipe', 'pipe']`
   - 特点：使用 `setsid` 创建新的进程组（macOS/Linux）

## 模式对比

### PTY 模式（Pseudoterminal）

**工作原理：**
- 使用 `node-pty` 创建伪终端（PTY）
- Shell 认为自己在真正的终端中运行
- 完全模拟真实的终端环境

**优点：**
- ✅ Shell 行为与真实终端一致
- ✅ 自动处理输入回显（shell 自己回显）
- ✅ 信号传递自然（Ctrl+C 等）
- ✅ 支持完整的终端功能（颜色、光标控制等）
- ✅ 不需要手动处理输入回显
- ✅ 子进程管理更简单

**缺点：**
- ❌ 需要 `node-pty` 原生模块（需要编译）
- ❌ 在某些环境下可能失败（如 macOS 权限问题、环境变量问题）
- ❌ Windows 支持有限

**适用场景：**
- macOS/Linux 系统
- `node-pty` 可用且稳定
- 需要完整的终端体验

### Pipe 模式（标准输入/输出管道）

**工作原理：**
- 使用 `child_process.spawn` 创建进程
- 通过 `stdio: ['pipe', 'pipe', 'pipe']` 建立管道连接
- Shell 检测到 stdin/stdout 不是 TTY，行为可能不同
- 使用 `setsid` 创建新的进程组（macOS/Linux）

**优点：**
- ✅ 不依赖原生模块，纯 Node.js 实现
- ✅ 跨平台支持（包括 Windows）
- ✅ 更稳定（不会因为 PTY 失败而无法使用）
- ✅ 可以精确控制进程组

**缺点：**
- ❌ Shell 检测到非 TTY，可能禁用某些功能
- ❌ 需要手动处理输入回显（xterm.js 本地回显）
- ❌ 信号传递需要特殊处理（进程组管理）
- ❌ 某些 shell 配置可能导致问题（如 zsh 检测到非交互式退出）
- ❌ 需要手动实现命令历史等功能

**适用场景：**
- Windows 系统
- PTY 模式失败时的回退方案
- 需要更精确的进程控制

## 当前实现的问题

### Pipe 模式的问题

1. **输入回显问题**
   - Shell 不回显输入（因为 stdin 不是 TTY）
   - 解决方案：在 xterm.js 中手动回显输入

2. **信号传递问题**
   - Ctrl+C 只影响 shell 进程，不影响子进程
   - 解决方案：使用 `setsid` 创建进程组，发送信号到进程组

3. **命令历史问题**
   - Shell 的历史功能可能不可用
   - 解决方案：在前端实现命令历史

4. **提示符问题**
   - 提示符可能不显示或格式不正确
   - 解决方案：从输出中提取提示符，手动显示

## 为什么使用 Pipe 模式？

从代码来看，**Pipe 模式是回退方案**，不是首选：

1. **首选是 PTY 模式**
   - 代码首先尝试使用 `node-pty`
   - 只有在 PTY 失败时才使用 Pipe 模式

2. **使用 Pipe 模式的原因**
   - PTY 在某些环境下失败（如 macOS 权限、环境变量问题）
   - Windows 系统不支持 PTY
   - 需要回退方案确保终端可用

3. **当前问题**
   - 如果 PTY 失败，系统会回退到 Pipe 模式
   - Pipe 模式需要大量手动处理（回显、信号、历史等）
   - 这导致了当前遇到的各种问题

## 改进建议

### 1. 优先修复 PTY 模式

**问题：** PTY 模式在某些环境下失败
**解决方案：**
- 检查并修复环境变量问题
- 确保 `node-pty` 正确安装和编译
- 添加更好的错误处理和诊断

### 2. 改进 Pipe 模式

**当前问题：**
- Ctrl+C 无法终止子进程
- 输入回显需要手动处理
- 命令历史需要手动实现

**已实现的改进：**
- ✅ 使用 `setsid` 创建进程组
- ✅ 手动输入回显
- ✅ 命令历史功能
- ✅ 提示符提取和显示

**还可以改进：**
- 更好的进程组管理
- 更可靠的信号传递
- 更完善的错误处理

### 3. 混合模式

**建议：**
- PTY 模式作为首选（更好的体验）
- Pipe 模式作为回退（确保可用性）
- 在 UI 中显示当前使用的模式（便于调试）

## 总结

| 特性 | PTY 模式 | Pipe 模式 |
|------|---------|----------|
| **输入回显** | ✅ 自动（shell 处理） | ❌ 需要手动（xterm.js） |
| **信号传递** | ✅ 自然 | ⚠️ 需要进程组管理 |
| **命令历史** | ✅ Shell 原生支持 | ❌ 需要手动实现 |
| **跨平台** | ❌ 仅 macOS/Linux | ✅ 包括 Windows |
| **稳定性** | ⚠️ 依赖原生模块 | ✅ 纯 Node.js |
| **功能完整性** | ✅ 完整 | ⚠️ 需要手动实现 |
| **当前状态** | ⚠️ 可能失败 | ✅ 回退方案 |

**结论：**
- PTY 模式是更好的选择，但需要确保稳定性
- Pipe 模式是必要的回退方案，但需要更多手动处理
- 当前实现已经做了很多改进，但仍有优化空间
