# 超级管理员使用指南

## 概述

OpenCowork 提供了超级管理员权限系统，允许管理员管理脚本、技能和 MCP 服务器，并将它们标记为"官方"或"内置"，以便分发给所有用户。

## 用户角色

### 普通用户（User）
- 默认角色
- 可以执行所有脚本
- 可以编辑自己的技能和 MCP 配置
- **不能**删除、重命名脚本
- **不能**标记脚本为官方
- **不能**标记技能/MCP 为内置
- **不能**删除用户技能和 MCP

### 超级管理员（Admin）
- 拥有所有权限
- 可以重命名和删除脚本
- 可以标记脚本为官方
- 可以标记技能为内置
- 可以标记 MCP 服务器为内置
- 可以删除用户技能和 MCP 服务器

## 预设管理员机制

### 什么是预设管理员？

预设管理员是在应用安装时通过配置文件预设的管理员用户。这些用户在首次启动应用时会自动获得管理员权限，无需手动切换。

### 如何设置预设管理员？

#### 方法1：在打包前配置（推荐）

1. 编辑 `resources/admin-users.json` 文件
2. 在 `adminUsers` 数组中添加系统用户名（例如：`["shilei", "admin"]`）
3. 重新打包应用
4. 安装后，列表中的用户将自动成为管理员

**示例配置**：
```json
{
  "version": "1.0.0",
  "adminUsers": [
    "shilei",
    "admin"
  ],
  "adminEmails": [],
  "adminMacAddresses": []
}
```

#### 方法2：通过管理员界面添加

1. 以管理员身份登录应用
2. 打开设置，切换到"管理员"标签页
3. 在"预设管理员列表"部分，输入系统用户名
4. 点击"添加"按钮
5. 新添加的用户将在下次启动应用时自动获得管理员权限

### 用户识别机制

应用通过以下方式识别用户：

1. **系统用户名**（主要方式）
   - macOS/Linux: `os.userInfo().username`
   - Windows: `os.userInfo().username`
   - 用户名比较时不区分大小写

2. **未来可扩展的识别方式**（已预留接口）
   - 邮箱地址
   - MAC 地址
   - 其他唯一标识符

### 预设管理员的工作流程

1. **首次启动**：
   - 应用读取 `resources/admin-users.json` 配置文件
   - 获取当前系统用户名
   - 检查用户名是否在预设管理员列表中
   - 如果在列表中，自动将用户角色设置为 `admin`
   - 如果不在列表中，默认为 `user`

2. **后续启动**：
   - 如果用户已手动设置过角色，使用已设置的角色
   - 如果用户未设置过角色，再次检查预设管理员列表

### 查看当前用户信息

1. 打开设置，切换到"管理员"标签页
2. 在"当前角色"下方可以看到"当前用户"信息
3. 显示的是系统用户名（用于识别预设管理员）

## 切换用户角色

### 手动切换为管理员

如果当前用户不是预设管理员，可以通过以下方式手动切换：

1. 打开应用设置（点击右上角设置图标）
2. 切换到"管理员"标签页
3. 点击"切换为超级管理员"按钮
4. 确认切换操作
5. 应用将自动刷新以应用新的权限

**注意**：
- 只有当前管理员可以授予其他用户管理员权限
- 普通用户无法自行提升为管理员（除非是预设管理员）
- 切换后，所有管理员功能将立即可用

### 切换为普通用户

管理员可以随时切换回普通用户：

1. 打开设置，切换到"管理员"标签页
2. 点击"切换为普通用户"按钮
3. 确认切换操作
4. 应用将自动刷新，管理员功能将被隐藏

## 管理员功能

### 1. 脚本管理

#### 重命名脚本
1. 在"自动化"标签页中，找到要重命名的脚本
2. 鼠标悬停在脚本上，点击编辑图标（铅笔图标）
3. 输入新名称，按 Enter 确认或 Esc 取消
4. 脚本文件将自动重命名

#### 标记脚本为官方
1. 在"自动化"标签页中，找到要标记的脚本
2. 鼠标悬停在脚本上，点击星标图标（⭐）
3. 确认标记操作
4. 脚本将被复制到 `resources/skills/chrome-agent/` 目录
5. 脚本信息将被添加到 `official-scripts.json` 清单文件
6. 脚本将同步到所有用户的目录

**官方脚本特性**：
- 不能被普通用户删除
- 随应用分发给所有用户
- 显示"官方"标识

#### 删除脚本
1. 在"自动化"标签页中，找到要删除的脚本
2. 鼠标悬停在脚本上，点击删除图标（垃圾桶图标）
3. 确认删除操作
4. 脚本文件将被永久删除

**注意**：官方脚本不能被删除。

### 2. 技能管理

#### 标记技能为内置
1. 打开设置，切换到"技能"标签页
2. 在用户技能列表中，找到要标记的技能
3. 鼠标悬停在技能上，点击星标图标（⭐）
4. 确认标记操作
5. 技能目录将被复制到 `resources/skills/` 目录
6. 技能将从用户目录中移除

**内置技能特性**：
- 随应用分发给所有用户
- 不能被普通用户删除
- 显示"内置"标识

#### 删除用户技能
1. 打开设置，切换到"技能"标签页
2. 在用户技能列表中，找到要删除的技能
3. 鼠标悬停在技能上，点击删除图标（垃圾桶图标）
4. 确认删除操作
5. 技能目录将被永久删除

**注意**：内置技能不能被删除。

### 3. MCP 服务器管理

#### 标记 MCP 为内置
1. 打开设置，切换到"MCP"标签页
2. 在用户添加的 MCP 服务器列表中，找到要标记的服务器
3. 鼠标悬停在服务器上，点击星标图标（⭐）
4. 确认标记操作
5. MCP 配置将被添加到 `resources/mcp/builtin-mcp.json`
6. MCP 的 `source` 字段将被设置为 `builtin`

**内置 MCP 特性**：
- 随应用分发给所有用户
- 不能被普通用户删除
- 显示"内置"标识

#### 删除用户 MCP
1. 打开设置，切换到"MCP"标签页
2. 在用户添加的 MCP 服务器列表中，找到要删除的服务器
3. 鼠标悬停在服务器上，点击删除图标（垃圾桶图标）
4. 确认删除操作
5. MCP 配置将被永久删除

**注意**：内置 MCP 不能被删除。

## 权限检查机制

### 前端权限控制
- UI 按钮根据用户角色显示/隐藏
- 普通用户看不到管理员操作按钮
- 管理员可以看到所有操作按钮

### 后端权限验证
- 所有修改操作都经过服务端权限检查
- 权限检查失败时返回明确的错误信息
- 前端 UI 仅用于用户体验，不用于安全控制

## 资源标记流程

### 脚本标记为官方
1. 读取脚本文件内容
2. 将脚本文件复制到 `resources/skills/chrome-agent/`
3. 更新 `official-scripts.json` 添加脚本信息
4. 同步到用户目录（通过 `syncOfficialScripts()`）

### 技能标记为内置
1. 读取技能目录内容
2. 将技能目录复制到 `resources/skills/`
3. 从用户目录删除技能
4. 更新技能列表

### MCP 标记为内置
1. 读取 MCP 配置
2. 添加到 `resources/mcp/builtin-mcp.json`
3. 更新 MCP 配置中的 `source` 为 `builtin`
4. 保存配置

## 安全考虑

### 权限验证
- 所有权限检查在服务端进行
- 前端 UI 仅用于用户体验，不用于安全控制
- 权限状态可以缓存，但关键操作必须实时验证

### 资源保护
- 内置资源不能被普通用户修改
- 官方脚本不能被普通用户删除
- 标记操作需要确认对话框
- 删除操作需要确认对话框

## 常见问题

### Q: 如何增加预设管理员？
A: 有两种方式：
1. **打包前配置**：编辑 `resources/admin-users.json`，添加用户名到 `adminUsers` 数组，然后重新打包
2. **运行时添加**：以管理员身份登录，在"管理员"标签页的"预设管理员列表"中添加新用户

### Q: 如何查看当前系统用户名？
A: 在"管理员"标签页中，查看"当前用户"信息，显示的就是系统用户名。

### Q: 预设管理员和手动切换的管理员有什么区别？
A: 
- **预设管理员**：通过配置文件预设，首次启动时自动获得权限，即使重置配置也会自动恢复
- **手动切换的管理员**：通过 UI 手动切换，存储在用户配置中，可以随时切换回普通用户

### Q: 如何重置为普通用户？
A: 在"管理员"标签页中，点击"切换为普通用户"按钮。注意：预设管理员在下次启动时会自动恢复为管理员。

### Q: 如何移除预设管理员？
A: 以管理员身份登录，在"管理员"标签页的"预设管理员列表"中，点击用户名旁边的删除按钮。

### Q: 预设管理员配置文件在哪里？
A: 
- **开发环境**：`resources/admin-users.json`
- **生产环境**：打包后的 `resources/admin-users.json`（位于应用资源目录）

### Q: 如何判定安装客户端的用户是预设的管理员用户？
A: 应用在首次启动时会：
1. 读取 `resources/admin-users.json` 配置文件
2. 获取当前系统用户名（`os.userInfo().username`）
3. 检查用户名是否在 `adminUsers` 列表中（不区分大小写）
4. 如果在列表中，自动设置为管理员；否则默认为普通用户

### Q: 标记为官方/内置后，如何撤销？
A: 目前不支持直接撤销。需要手动从 `resources/` 目录中删除文件，并更新相应的清单文件。

### Q: 官方脚本和内置技能有什么区别？
A: 
- **官方脚本**：存储在 `resources/skills/chrome-agent/`，通过 `official-scripts.json` 管理
- **内置技能**：存储在 `resources/skills/`，随应用分发

### Q: 标记操作失败怎么办？
A: 
1. 检查文件权限
2. 检查磁盘空间
3. 查看控制台错误信息
4. 确保 `resources/` 目录可写

### Q: 如何查看当前用户角色？
A: 在设置页面的"管理员"标签页中查看"当前角色"。

## 技术实现

### 权限服务
- `PermissionService`：统一管理权限检查
- 存储在 `ConfigStore` 中
- 通过 IPC 与前端通信

### 权限检查点
- 脚本操作：删除、重命名、标记官方
- 技能操作：编辑、删除、标记内置
- MCP 操作：删除、标记内置

### IPC Handlers
- `permission:get-role`：获取当前用户角色
- `permission:set-role`：设置用户角色
- `permission:is-admin`：检查是否为管理员
- `script:rename`：重命名脚本（需要管理员权限）
- `script:mark-official`：标记脚本为官方（需要管理员权限）
- `skill:mark-builtin`：标记技能为内置（需要管理员权限）
- `mcp:mark-builtin`：标记 MCP 为内置（需要管理员权限）

## 最佳实践

1. **谨慎标记**：标记为官方/内置的资源将分发给所有用户，请确保资源质量
2. **定期审查**：定期审查官方脚本和内置资源，确保它们仍然有用
3. **文档完善**：为官方脚本和内置资源提供清晰的文档和说明
4. **版本管理**：在 `official-scripts.json` 中维护脚本版本信息
5. **测试验证**：标记前充分测试，确保资源正常工作

## 相关文件

- `electron/config/PermissionService.ts`：权限管理服务（包含预设管理员逻辑）
- `electron/config/ConfigStore.ts`：配置存储（包含用户角色）
- `electron/config/ScriptStore.ts`：脚本管理（包含标记官方逻辑）
- `electron/main.ts`：IPC handlers 和权限检查
- `electron/agent/mcp/MCPClientService.ts`：MCP 管理（包含标记内置逻辑）
- `resources/admin-users.json`：预设管理员配置文件
- `resources/skills/chrome-agent/official-scripts.json`：官方脚本清单
- `resources/mcp/builtin-mcp.json`：内置 MCP 配置

## 更新日志

- **v0.0.3**：初始版本，支持基本的权限管理和资源标记功能
- **v0.0.4**：完善版本，支持预设管理员机制、用户账户信息获取、完整的权限管理系统
